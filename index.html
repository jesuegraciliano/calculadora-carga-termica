<script>
    document.addEventListener("DOMContentLoaded", function () {
        const thermalDataConfig = [
            { label: "Área de paredes ao Sol (m²)", fator: 43, id: "dado1" },
            { label: "Área de paredes à sombra (m²)", fator: 18, id: "dado2" },
            { label: "Área de janela/porta de vidro ao sol (m²)", fator: 520, id: "dado3" },
            { label: "Área de janela/porta vidro ao sol com cortina (m²)", fator: 353, id: "dado4" },
            { label: "Área de janela/porta de vidro à sombra (m²)", fator: 42, id: "dado5" },
            { label: "Área de cobertura (m²)", fator: 20, id: "dado6" },
            { label: "Área de piso entre andares (m²)", fator: 10, id: "dado7" },
            { label: "Número de pessoas (quantidade)", fator: 100, id: "dado8" },
            { label: "Potência dos equipamentos (Watts)", fator: 0.86, id: "dado9" }, // Fator W para kcal/h (1W = 0.86 kcal/h)
            { label: "Potência de iluminação (Watts)", fator: 0.86, id: "dado10" }, // Fator W para kcal/h (1W = 0.86 kcal/h)
            { label: "Vazão de ar de renovação (m³/h)", fator: 8.2, id: "dado11" }
        ];

        // Elementos das seções
        const inputSection = document.getElementById('inputSection');
        const resultsSection = document.getElementById('resultsSection');

        // Elementos da seção de entrada
        const tableBodyInput = document.getElementById("thermalBody");
        const totalKcalhInstant = document.getElementById("totalKcalhInstant");
        const totalTRInstant = document.getElementById("totalTRInstant");
        const goToResultsButton = document.getElementById("goToResults");

        // Elementos da seção de resultados
        const resultsBody = document.getElementById("resultsBody");
        const totalKcalhFinal = document.getElementById("totalKcalhFinal");
        const totalTRFinal = document.getElementById("totalTRFinal");
        const thermalChartCanvas = document.getElementById('thermalChart');
        let myChart = null; // Para armazenar a instância do gráfico
        const backToInputButton = document.getElementById('backToInput');

        // --- Lógica para a Seção de Entrada (Input Section) ---
        function setupInputSection() {
            // Limpar o corpo da tabela antes de preencher
            tableBodyInput.innerHTML = '';

            thermalDataConfig.forEach(item => {
                const tr = document.createElement("tr");

                const tdLabel = document.createElement("td");
                tdLabel.textContent = item.label;

                const tdInput = document.createElement("td");
                const input = document.createElement("input");
                input.type = "number";
                input.placeholder = "0";
                input.classList.add("input");
                input.id = item.id;
                input.addEventListener("input", calculateInstantCarga);
                tdInput.appendChild(input);

                const tdFator = document.createElement("td");
                tdFator.textContent = item.fator.toFixed(2);
                tdFator.classList.add("fixed");

                const tdResultado = document.createElement("td");
                tdResultado.textContent = "0.00";
                tdResultado.id = item.id + "_resultado";
                tdResultado.classList.add("output");

                tr.appendChild(tdLabel);
                tr.appendChild(tdInput);
                tr.appendChild(tdFator);
                tr.appendChild(tdResultado);

                tableBodyInput.appendChild(tr);
            });

            // Tenta carregar dados do localStorage se existirem
            const savedInputs = JSON.parse(localStorage.getItem("thermalCalcInputs"));
            if (savedInputs) {
                thermalDataConfig.forEach(item => {
                    const input = document.getElementById(item.id);
                    if (input && savedInputs[item.id] !== undefined) {
                        input.value = savedInputs[item.id];
                    }
                });
            }
            calculateInstantCarga(); // Calcula com os valores carregados ou 0
        }

        // Função para calcular e exibir a carga térmica instantânea na seção de entrada
        function calculateInstantCarga() {
            let currentTotal = 0;
            thermalDataConfig.forEach(item => {
                const input = document.getElementById(item.id);
                const valor = parseFloat(input.value.replace(",", ".")) || 0;
                const carga = valor * item.fator;
                currentTotal += carga;

                const resultado = document.getElementById(item.id + "_resultado");
                if (resultado) resultado.textContent = carga.toFixed(2);
            });

            if (totalKcalhInstant) totalKcalhInstant.textContent = currentTotal.toFixed(2) + " kcal/h";
            const trInstant = currentTotal / 3000;
            const btuhInstant = trInstant * 12000;
            if (totalTRInstant) totalTRInstant.textContent = `${trInstant.toFixed(2)} TR | ${btuhInstant.toFixed(2)} BTU/h`;
        }

        // Event listener para o botão "Ver Resultados Detalhados"
        if (goToResultsButton) {
            goToResultsButton.addEventListener("click", () => {
                const inputValues = {};
                thermalDataConfig.forEach(item => {
                    const input = document.getElementById(item.id);
                    inputValues[item.id] = parseFloat(input.value.replace(",", ".")) || 0;
                });
                localStorage.setItem("thermalCalcInputs", JSON.stringify(inputValues)); // Salva os dados
                showSection('results'); // Mostra a seção de resultados
            });
        }

        // --- Lógica para a Seção de Resultados (Results Section) ---
        function displayResultsSection() {
            const savedInputs = JSON.parse(localStorage.getItem("thermalCalcInputs"));
            if (!savedInputs) {
                // Se não houver dados, volta para a entrada
                showSection('input');
                return;
            }

            let totalCargaKcalh = 0;
            const chartLabels = [];
            const chartDataValues = []; // Alterado para armazenar números
            const backgroundColors = [];
            const borderColors = [];

            resultsBody.innerHTML = ''; // Limpa o corpo da tabela de resultados

            thermalDataConfig.forEach((item, index) => {
                const inputValue = savedInputs[item.id] || 0;
                const itemCarga = inputValue * item.fator;
                totalCargaKcalh += itemCarga;

                // Adiciona dados para o gráfico (apenas se a carga for maior que 0)
                if (itemCarga > 0) {
                    chartLabels.push(item.label);
                    chartDataValues.push(parseFloat(itemCarga.toFixed(2))); // Garante que seja um número formatado
                    const hue = (index * 137) % 360;
                    backgroundColors.push(`hsl(${hue}, 70%, 70%)`);
                    borderColors.push(`hsl(${hue}, 70%, 50%)`);
                }

                // Cria a linha da tabela de resultados detalhados
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${item.label}</td>
                    <td>${inputValue.toFixed(2)}</td>
                    <td>${item.fator.toFixed(2)}</td>
                    <td>${itemCarga.toFixed(2)}</td>
                `;
                resultsBody.appendChild(tr);
            });

            // Exibe os totais finais
            if (totalKcalhFinal) totalKcalhFinal.textContent = totalCargaKcalh.toFixed(2) + " kcal/h";
            const totalTRFinalValue = totalCargaKcalh / 3000;
            const totalBTUhFinalValue = totalTRFinalValue * 12000;
            if (totalTRFinal) totalTRFinal.textContent = `${totalTRFinalValue.toFixed(2)} TR | ${totalBTUhFinalValue.toFixed(2)} BTU/h`;

            // Renderiza o gráfico de barras
            if (thermalChartCanvas) {
                // Destruir o gráfico antigo se existir
                if (myChart) {
                    myChart.destroy();
                }
                // Verifica se há dados para exibir no gráfico antes de criar
                if (chartLabels.length > 0) {
                    myChart = new Chart(thermalChartCanvas, {
                        type: 'bar',
                        data: {
                            labels: chartLabels,
                            datasets: [{
                                label: 'Carga Térmica por Item (kcal/h)',
                                data: chartDataValues,
                                backgroundColor: backgroundColors,
                                borderColor: borderColors,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Carga Térmica (kcal/h)'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Item de Carga'
                                    }
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed.y !== null) {
                                                label += new Intl.NumberFormat('pt-BR', { style: 'decimal' }).format(context.parsed.y) + ' kcal/h';
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                } else {
                    // Se não houver dados, exibir uma mensagem ou garantir que o canvas esteja limpo
                    const context = thermalChartCanvas.getContext('2d');
                    context.clearRect(0, 0, thermalChartCanvas.width, thermalChartCanvas.height);
                    // Opcional: Adicionar um texto no canvas se desejar
                    // context.font = '16px Arial';
                    // context.textAlign = 'center';
                    // context.fillText('Nenhum dado para o gráfico.', thermalChartCanvas.width / 2, thermalChartCanvas.height / 2);
                }
            }
        }

        // Event listener para o botão "Voltar à Entrada"
        if (backToInputButton) {
            backToInputButton.addEventListener('click', () => {
                showSection('input'); // Mostra a seção de entrada
            });
        }

        // --- Gerenciamento de Seções ---
        function showSection(sectionName) {
            if (sectionName === 'input') {
                inputSection.classList.remove('hidden');
                resultsSection.classList.add('hidden');
                setupInputSection(); // Re-popula a seção de entrada com dados salvos
            } else if (sectionName === 'results') {
                inputSection.classList.add('hidden');
                resultsSection.classList.remove('hidden');
                displayResultsSection(); // Popula e mostra a seção de resultados
            }
        }

        // Inicia mostrando a seção de entrada
        showSection('input');
    });
</script>
